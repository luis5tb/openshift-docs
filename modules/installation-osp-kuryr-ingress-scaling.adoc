// Module included in the following assemblies:
//
// * networking/openstack/load-balancing-openstack.adoc

[id="installation-osp-kuryr-octavia-configure{context}"]
= Scaling Ingress using {rh-openstack} Octavia on Kuryr deployments

Ingress can be scaled on {product-title} cluster that uses Kuryr by using
Octavia Load Balancers.
Octavia is a requirement to deploy {product-title} with Kuryr, as Kuryr uses it
to create the services.
This can be leveraged to create extra Ingress APIs and better scale with the
load.
This allows to remove the Ingress bottleneck as currently the traffics enters
through the worker node that holds the Ingress VIP.

The steps to follow are the next:

. Copy the current internal router service:
+
----
$ oc -n openshift-ingress get svc router-internal-default -o yaml > external_router.yaml
----

. Change the `name` (e.g., `router-external-default`) and the `type` to
`LoadBalancer` so that Kuryr associates a Floating IP to the Load Balancer VIP.
Also remove all the extra information not needed such as timeStamps, IDs, ...
+
----
$ cat external_router.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    ingresscontroller.operator.openshift.io/owning-ingresscontroller: default
  name: router-external-default
  namespace: openshift-ingress
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: http
  - name: https
    port: 443
    protocol: TCP
    targetPort: https
  - name: metrics
    port: 1936
    protocol: TCP
    targetPort: 1936
  selector:
    ingresscontroller.operator.openshift.io/deployment-ingresscontroller: default
  sessionAffinity: None
  type: LoadBalancer
----

. And create the above service:
+
----
$ oc apply -f external_router.yaml
----

. Check the `external-ip` that the service got, and ensure it is the same as the one associated to the created load balancer:
+
----
$ oc -n openshift-ingress get svc
NAME                      TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                     AGE
router-external-default   LoadBalancer   172.30.235.33    <pending>     80:30112/TCP,443:32359/TCP,1936:30317/TCP   10s
router-internal-default   ClusterIP      172.30.115.123   <none>        80/TCP,443/TCP,1936/TCP                     22h

$ oc -n openshift-ingress get svc
NAME                      TYPE           CLUSTER-IP       EXTERNAL-IP    PORT(S)                                     AGE
router-external-default   LoadBalancer   172.30.235.33    10.46.22.161   80:30112/TCP,443:32359/TCP,1936:30317/TCP   3m38s
router-internal-default   ClusterIP      172.30.115.123   <none>         80/TCP,443/TCP,1936/TCP                     22h

$ openstack loadbalancer list | grep router-external
| 21bf6afe-b498-4a16-a958-3229e83c002c | openshift-ingress/router-external-default                                   | 66f3816acf1b431691b8d132cc9d793c | 172.30.235.33  | ACTIVE              | octavia  |

$ openstack floating ip list | grep 172.30.235.33
| e2f80e97-8266-4b69-8636-e58bacf1879e | 10.46.22.161        | 172.30.235.33    | 655e7122-806a-4e0a-a104-220c6e17bda6 | a565e55a-99e7-4d15-b4df-f9d7ee8c9deb | 66f3816acf1b431691b8d132cc9d793c |
----

The `external-ip` is the new Ingress IP to use externally.

Note that if Kuryr uses Octavia Amphora driver, still the traffic will go
through a single VM (in this case the Amphora VM). So, to avoid this the above
steps can be replicated as many times as desired, creating different Ingress
Floating IPs that can be used to achieve better performance.

By contrast, if Octavia OVN driver is used, the traffic is already distributed
and it will enter the cluster though the OVN gateway nodes (same as any other
N/S traffic). Anyway, it is also possible to create several external
(LoadBalancer type) services with it too.

